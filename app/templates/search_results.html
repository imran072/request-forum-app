{% extends 'default.html' %}

{% block content %}
<div class="container mt-5">
    <h2>Search Results</h2>
    {% if vehicles %}
    <p>{{ vehicles|length }} EV{{ 's' if vehicles|length > 1 else '' }} found</p>
    <div class="row">
        {% for vehicle in vehicles %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <img src="{{ vehicle.image_url }}" class="card-img-top" alt="{{ vehicle.model_rel.name }}">
                <div class="card-body">
                    <h5 class="card-title">{{ vehicle.brand.name }} {{ vehicle.model_rel.name }}</h5>
                    <p class="card-text"><strong>Price:</strong> ${{ vehicle.price }}</p>
                    <p class="card-text"><strong>Year:</strong> {{ vehicle.year }}</p>
                    <p class="card-text"><strong>Mileage:</strong> {{ vehicle.mileage }} km</p>
                    <p class="card-text"><strong>Battery Capacity:</strong> {{ vehicle.battery_capacity }} kWh</p>
                    <p class="card-text"><strong>Color:</strong> {{ vehicle.color }}</p>
                    <p class="card-text"><strong>Doors:</strong> {{ vehicle.doors }}</p>
                    <p class="card-text"><strong>Car Type:</strong> {{ vehicle.car_type }}</p>
                    <p class="card-text"><strong>Top Speed:</strong> {{ vehicle.top_speed }} km/h</p>
                    <p class="card-text"><strong>Acceleration:</strong> 0-100 km/h in {{ vehicle.acceleration }} seconds</p>
                </div>
<div class="card-footer">
    <small class="text-muted">Seller: {{ vehicle.seller.username }} - {{ vehicle.seller.email }}</small>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#messageModal" data-recipient="{{ vehicle.seller.username }}" data-recipient-name="{{ vehicle.seller.username }}" data-vehicle-details="{{ vehicle.brand.name }} {{ vehicle.model_rel.name }} ({{ vehicle.year }}) for ${{ vehicle.price }}">Message Seller</button>
</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No results found.</p>
    {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Send Message to <span id="recipientName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('main.send_message') }}">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="recipient" id="recipientUsername">
                    <input type="hidden" name="vehicle_details" id="vehicleDetails">
                    <div class="form-group">
                        <label for="body">Message</label>
                        <textarea name="body" class="form-control" id="body" required></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.jQuery) {
            $('#messageModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var recipientUsername = button.data('recipient');
                var recipientName = button.data('recipient-name');
                var vehicleDetails = button.data('vehicle-details');

                var modal = $(this);
                modal.find('#recipientUsername').val(recipientUsername);
                modal.find('#recipientName').text(recipientName);
                modal.find('#vehicleDetails').val(vehicleDetails);
                modal.find('#body').val('I am interested in your listing: ' + vehicleDetails + '\n\n');
            });
        } else {
            console.error('jQuery is not loaded');
        }
    });
</script>
{% endblock %}
